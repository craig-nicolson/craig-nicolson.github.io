import{r as z,a as S,c as F,s as Y,b as L}from"./overlayControls-D9GsMX9d.js";/* empty css              */import{S as G}from"./signalBatchRenderer-O_VuUkYA.js";import"./signalSquare-Bn1rA2Su.js";class I{constructor(e,t){this.container=e,this.config=t,this.enabled=!1}init(){}setEnabled(e){this.enabled=e}update(e){}triggerPulse(e,t,i,a,r,s){}dispose(){}getConfigOptions(){return[]}updateConfig(e){Object.assign(this.config,e)}}class f{static sharedTemplates=new Map;constructor(e,t,i,a,r,s,n=0,l={}){this.startX=e,this.startY=t,this.endX=i,this.endY=a,this.column=r,this.row=s,this.bundleCenterX=n,this.config=l||{};const c=this.config||{},d=`col_${r}_row_${s}_strength_${c.wireCurveStrength||25}`;f.sharedTemplates.has(d)?this.reuseSharedTemplate(d):(this.computeNewTemplate(),f.sharedTemplates.set(d,{relativeControlX:this.relativeControlX,relativeControlY:this.relativeControlY,curvePoints:this.curvePoints})),this.computeAbsoluteCoordinates()}reuseSharedTemplate(e){const t=f.sharedTemplates.get(e);this.relativeControlX=t.relativeControlX,this.relativeControlY=t.relativeControlY,this.curvePoints=t.curvePoints}computeNewTemplate(){this.relativeControlX=this.calculateRelativeControlX(),this.relativeControlY=this.calculateRelativeControlY(),this.precomputeRelativeCurvePoints()}computeAbsoluteCoordinates(){const e=(this.startX+this.endX)/2,t=(this.startY+this.endY)/2;this.controlX=e+this.relativeControlX,this.controlY=t+this.relativeControlY,this.absoluteCurvePoints=this.curvePoints.map(i=>({x:e+i.x,y:t+i.y,t:i.t}))}calculateRelativeControlX(){const e=this.config.wireCurveStrength||25;let t=0;this.column===0?t=-e*1.2:this.column===1?t=-e*.6:this.column===3?t=e*.6:this.column===4&&(t=e*1.2);const i=this.endX-this.startX,a=this.endY-this.startY,r=Math.sqrt(i*i+a*a);return a/r*t}calculateRelativeControlY(){const e=this.config.wireCurveStrength||25;let t=0;this.column===0?t=-e*1.2:this.column===1?t=-e*.6:this.column===3?t=e*.6:this.column===4&&(t=e*1.2);const i=this.endX-this.startX,a=this.endY-this.startY,r=Math.sqrt(i*i+a*a);return-i/r*t}precomputeRelativeCurvePoints(){this.curvePoints=[];const e=12;for(let t=0;t<=e;t++){const i=t/e,a=this.startX-(this.startX+this.endX)/2,r=this.startY-(this.startY+this.endY)/2,s=this.endX-(this.startX+this.endX)/2,n=this.endY-(this.startY+this.endY)/2,l=this.relativeControlX,c=this.relativeControlY,d=(1-i)*(1-i)*a+2*(1-i)*i*l+i*i*s,u=(1-i)*(1-i)*r+2*(1-i)*i*c+i*i*n;this.curvePoints.push({x:d,y:u,t:i})}}getPointAtProgress(e){const t=Math.floor(e*(this.absoluteCurvePoints.length-1)),i=Math.min(t+1,this.absoluteCurvePoints.length-1),a=this.absoluteCurvePoints[t],r=this.absoluteCurvePoints[i],s=e*(this.absoluteCurvePoints.length-1)-t;return{x:a.x+(r.x-a.x)*s,y:a.y+(r.y-a.y)*s}}drawInactive(e){const t=e.createLinearGradient(this.startX,this.startY,this.endX,this.endY);t.addColorStop(0,"rgba(68,68,68,0.4)"),t.addColorStop(.6,"rgba(68,68,68,0.4)"),t.addColorStop(1,"rgba(68,68,68,0)"),e.strokeStyle=t,e.lineWidth=this.config.wireLineThickness||1.5,e.globalAlpha=1,e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(this.startX,this.startY),e.quadraticCurveTo(this.controlX,this.controlY,this.endX,this.endY),e.stroke()}}class O{constructor(e,t,i,a,r=0,s=0,n=0,l=0,c){this.template=new f(e,t,i,a,r,s,n,c),this.isActive=!1,this.pulseProgress=0,this.pulseSpeed=c.wirePulseSpeed||2.2,this.lastPulseTime=0,this.bundleIndex=l,this.column=r,this.row=s,this.uniqueId=`bundle_${l}_col_${r}_row_${s}`}triggerPulse(){this.isActive=!0,this.pulseProgress=0,this.lastPulseTime=0}update(e){if(this.isActive){if(this.lastPulseTime===0)return this.lastPulseTime=e,!0;const t=(e-this.lastPulseTime)/1e3;if(this.pulseProgress+=this.pulseSpeed*t,this.lastPulseTime=e,this.pulseProgress>=1)return this.isActive=!1,this.pulseProgress=0,!1}return this.isActive&&this.pulseProgress>0}drawInactive(e){this.template.drawInactive(e)}drawPulse(e,t){if(t<.02||t>.99)return;const i=5,a=.15,r=(1-t)*1.5;if(!(r<=.005)){e.fillStyle="#00ff6a",e.shadowColor="#00ff6a";for(let s=0;s<i;s++){const n=t-s*a/i;if(n<0)continue;const l=r*(1-s/i)*(1-n);if(l<=.005)continue;const c=this.template.getPointAtProgress(n);e.globalAlpha=l,e.shadowBlur=8+s*.8,e.beginPath(),e.arc(c.x,c.y,2-s*.12,0,Math.PI*2),e.fill(),s===0&&(e.globalAlpha=Math.min(1,l*1.4),e.shadowBlur=8,e.beginPath(),e.arc(c.x,c.y,1.1,0,Math.PI*2),e.fill())}}}}class X{constructor(e,t){this.container=e,this.config=t,this.canvas=null,this.ctx=null,this.lines=new Map,this.enabled=!1,this.lastTime=0,this.lastInactiveDraw=0,this.inactiveCanvas=null,this.inactiveCtx=null,this.inactiveDirty=!0,this.activePulses=new Map,this.init()}init(){this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="10",this.canvas.style.width="100%",this.canvas.style.height="100%",this.ctx=this.canvas.getContext("2d"),this.container.appendChild(this.canvas),this.ctx||console.error("WireAnimator: Failed to get 2D context!"),this.inactiveCanvas=document.createElement("canvas"),this.inactiveCtx=this.inactiveCanvas.getContext("2d"),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas&&(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.inactiveCanvas.width=this.canvas.width,this.inactiveCanvas.height=this.canvas.height,this.ctx&&(this.ctx.fillStyle="rgba(255, 0, 0, 0.1)",this.ctx.fillRect(10,10,50,50)),this.inactiveDirty=!0)}updateSquarePosition(e,t,i,a,r,s=0,n=0,l=0,c=0){if(!this.lines.has(e))this.lines.set(e,new O(t,i,a,r,s,n,l,c,this.config)),this.inactiveDirty=!0;else{const u=this.lines.get(e);(u.template.startX!==t||u.template.startY!==i||u.template.endX!==a||u.template.endY!==r)&&(u.template.startX=t,u.template.startY=i,u.template.endX=a,u.template.endY=r,u.template.bundleCenterX=l,u.template.computeAbsoluteCoordinates(),this.inactiveDirty=!0)}}triggerPulse(e){if(!this.enabled||!this.lines.has(e))return;const t=this.lines.get(e);t.triggerPulse(),this.activePulses.set(t.uniqueId,t)}update(e){if(this.enabled&&(this.lastTime&&(e-this.lastTime)/1e3,this.lastTime=e,this.inactiveDirty&&(this.drawInactiveLinesToOffscreen(),this.inactiveDirty=!1),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.inactiveCanvas,0,0),this.activePulses.size>0)){this.ctx.save();const t=[];for(const[i,a]of this.activePulses)a.update(e)?a.drawPulse(this.ctx,a.pulseProgress):t.push(i);t.forEach(i=>this.activePulses.delete(i)),this.ctx.restore()}}drawInactiveLinesToOffscreen(){this.inactiveCtx.clearRect(0,0,this.inactiveCanvas.width,this.inactiveCanvas.height),this.inactiveCtx.lineWidth=this.config.wireLineThickness||1.5,this.inactiveCtx.globalAlpha=1,this.inactiveCtx.lineCap="round",this.inactiveCtx.lineJoin="round",this.lines.forEach(e=>{const t=this.inactiveCtx.createLinearGradient(e.template.startX,e.template.startY,e.template.endX,e.template.endY);t.addColorStop(0,"rgba(68,68,68,0.4)"),t.addColorStop(.6,"rgba(68,68,68,0.4)"),t.addColorStop(1,"rgba(68,68,68,0)"),this.inactiveCtx.strokeStyle=t,this.inactiveCtx.beginPath(),this.inactiveCtx.moveTo(e.template.startX,e.template.startY),this.inactiveCtx.quadraticCurveTo(e.template.controlX,e.template.controlY,e.template.endX,e.template.endY),this.inactiveCtx.stroke()})}drawInactiveLines(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.inactiveCanvas,0,0)}setEnabled(e){this.enabled=e,e?this.drawInactiveLines():this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}initializeAllLines(e){if(!e)return;this.lines.clear(),e.getBundles().forEach((i,a)=>{i.getAllSquares().forEach(s=>{const n=e.config.squareSize,l=e.config.spacing;e.config.counterHeight;const d=5*n+4*l,u=i.position.x-d/2+n/2,g=2*n+l,w=i.position.y+g/2-n/2,T=u+s.column*(n+l),b=w-s.row*(n+l),x={x:T,y:b},C=e.worldToScreen(x),y=this.getBundleCounterPosition(i,a,e,s.column),A=i.position.x,P=`bundle_${a}_square_${s.column}_${s.row}`;this.updateSquarePosition(P,C.x,C.y,y.x,y.y,s.column,s.row,A,a)})}),this.drawInactiveLines()}getBundleCounterPosition(e,t,i,a=2){const r=i.config.spacing,s=i.config.counterHeight,n=i.config.squareSize,l=2*n+r,c=s*n+(s-1)*r,d=e.position.y-l/2-r-c/2,u={x:e.position.x,y:d};return i.worldToScreen(u)}dispose(){this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.lines.clear(),this.activePulses.clear(),f.sharedTemplates.clear()}}class v extends I{static CONFIG={"Line Thickness":{value:2.4,type:"range",min:.5,max:5,step:.1,label:"Line Thickness",section:"Wire Animation"},"Curve Strength":{value:25,type:"range",min:5,max:50,step:1,label:"Curve Strength",section:"Wire Animation"},"Pulse Speed":{value:2.2,type:"range",min:.5,max:5,step:.1,label:"Pulse Speed",section:"Wire Animation"}};constructor(e,t){const a={...{wireLineThickness:v.CONFIG["Line Thickness"].value,wireCurveStrength:v.CONFIG["Curve Strength"].value,wirePulseSpeed:v.CONFIG["Pulse Speed"].value},...t};super(e,a),this.pulseLineSystem=null}init(){this.pulseLineSystem=new X(this.container,this.config),this.pulseLineSystem.setEnabled(!1)}setEnabled(e){super.setEnabled(e),this.pulseLineSystem&&this.pulseLineSystem.setEnabled(e)}update(e){this.pulseLineSystem&&this.pulseLineSystem.update(e)}triggerPulse(e,t,i,a,r,s){!this.pulseLineSystem||!this.enabled||(this.pulseLineSystem.updateSquarePosition(e,t.x,t.y,i.x,i.y,a,r,0,s),this.pulseLineSystem.triggerPulse(e))}initializeAllLines(e){this.pulseLineSystem&&this.pulseLineSystem.initializeAllLines(e)}dispose(){this.pulseLineSystem&&this.pulseLineSystem.dispose()}getConfigOptions(){return[{type:"range",name:"wireLineThickness",label:"Line Thickness",value:this.config.wireLineThickness||v.CONFIG["Line Thickness"].value,min:.5,max:5,step:.1,section:"Wire Animation"},{type:"range",name:"wireCurveStrength",label:"Curve Strength",value:this.config.wireCurveStrength||v.CONFIG["Curve Strength"].value,min:5,max:50,step:1,section:"Wire Animation"},{type:"range",name:"wirePulseSpeed",label:"Pulse Speed",value:this.config.wirePulseSpeed||v.CONFIG["Pulse Speed"].value,min:.5,max:5,step:.1,section:"Wire Animation"}]}updateConfig(e){super.updateConfig(e),this.pulseLineSystem&&(this.pulseLineSystem.config=this.config,this.pulseLineSystem.inactiveDirty!==void 0&&(this.pulseLineSystem.inactiveDirty=!0)),e.wireLineThickness!==void 0&&(v.CONFIG["Line Thickness"].value=e.wireLineThickness),e.wireCurveStrength!==void 0&&(v.CONFIG["Curve Strength"].value=e.wireCurveStrength),e.wirePulseSpeed!==void 0&&(v.CONFIG["Pulse Speed"].value=e.wirePulseSpeed)}}class R{constructor(e,t,i,a,r){this.x=e,this.y=t,this.targetX=i,this.targetY=a,this.color=r.particleColor||"#23CD3C",this.size=r.particleSize||1.44,this.glow=r.particleGlow||.5,this.travelTime=r.particleTravelTime||.5,this.startTime=performance.now()/1e3,this.elapsed=0;const s=i-e,n=a-t;this.distance=Math.sqrt(s*s+n*n),this.distance===0?(this.speed=0,this.dirX=0,this.dirY=0):(this.speed=this.distance/this.travelTime,this.dirX=s/this.distance,this.dirY=n/this.distance),this.life=1,this.maxLife=1,this.alpha=1}update(e){if(this.elapsed+=e,this.elapsed<this.travelTime){const i=this.speed*e;this.x+=this.dirX*i,this.y+=this.dirY*i}else this.x=this.targetX,this.y=this.targetY;const t=Math.min(this.elapsed/this.travelTime,1);return this.alpha=1-t,this.alpha>0}draw(e){this.alpha<=0||(e.save(),e.globalAlpha=this.alpha,this.glow>0&&(e.shadowColor=this.color,e.shadowBlur=this.size*this.glow*4,e.shadowOffsetX=0,e.shadowOffsetY=0),e.fillStyle=this.color,e.beginPath(),e.arc(this.x,this.y,this.size,0,Math.PI*2),e.fill(),e.restore())}}class N{constructor(e,t){this.container=e,this.config=t,this.canvas=null,this.ctx=null,this.particles=[],this.particlePool=[],this.enabled=!1,this.maxParticles=1e4,this.lastTime=0,this.lastUpdateTime=0,this.init()}init(){this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="10",this.canvas.style.width="100%",this.canvas.style.height="100%",this.ctx=this.canvas.getContext("2d"),this.container.appendChild(this.canvas),this.ctx||console.error("ParticleAnimator: Failed to get 2D context!"),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas&&(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.ctx&&(this.ctx.fillStyle="rgba(0, 255, 0, 0.1)",this.ctx.fillRect(70,10,50,50)))}spawnParticle(e,t,i,a){if(!this.enabled||this.particles.length>=this.maxParticles)return;const r=this.config.particleTravelTime||.5;let s;if(this.particlePool.length>0){s=this.particlePool.pop(),s.x=e,s.y=t,s.targetX=i,s.targetY=a,s.color=this.config.particleColor||"#23CD3C",s.size=this.config.particleSize||1.44,s.glow=this.config.particleGlow||.5,s.travelTime=r,s.startTime=performance.now()/1e3,s.elapsed=0;const n=i-e,l=a-t;s.distance=Math.sqrt(n*n+l*l),s.distance===0?(s.speed=0,s.dirX=0,s.dirY=0):(s.speed=s.distance/r,s.dirX=n/s.distance,s.dirY=l/s.distance),s.life=1,s.maxLife=1,s.alpha=1}else{s=new R(e,t,i,a,this.config),s.travelTime=r;const n=i-e,l=a-t;s.distance=Math.sqrt(n*n+l*l),s.distance===0?(s.speed=0,s.dirX=0,s.dirY=0):(s.speed=s.distance/r,s.dirX=n/s.distance,s.dirY=l/s.distance)}this.particles.push(s)}update(e){if(!this.enabled)return;const t=this.lastTime?(e-this.lastTime)/1e3:0;if(this.lastTime=e,this.lastUpdateTime&&e-this.lastUpdateTime<16)return;this.lastUpdateTime=e;const i=[];this.particles.forEach(a=>{a.update(t)?i.push(a):this.particlePool.push(a)}),this.particles=i,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.particles.forEach(a=>a.draw(this.ctx))}setEnabled(e){this.enabled=e,e||(this.particles.forEach(t=>this.particlePool.push(t)),this.particles=[],this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height))}dispose(){this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.particles.forEach(e=>this.particlePool.push(e)),this.particles=[],this.particlePool=[]}}class p extends I{static CONFIG={"Particle Size":{value:1.44,type:"range",min:.5,max:5,step:.1,label:"Particle Size",section:"Particle Animation"},"Particle Glow":{value:.5,type:"range",min:0,max:2,step:.1,label:"Particle Glow",section:"Particle Animation"},"Travel Time":{value:.5,type:"range",min:.1,max:2,step:.1,label:"Travel Time (s)",section:"Particle Animation"},"Particle Color":{value:"#23CD3C",type:"color",label:"Particle Color",section:"Particle Animation"}};constructor(e,t){const a={...{particleSize:p.CONFIG["Particle Size"].value,particleGlow:p.CONFIG["Particle Glow"].value,particleTravelTime:p.CONFIG["Travel Time"].value,particleColor:p.CONFIG["Particle Color"].value},...t};super(e,a),this.particleSystem=null}init(){this.particleSystem=new N(this.container,this.config)}setEnabled(e){super.setEnabled(e),this.particleSystem&&this.particleSystem.setEnabled(e)}update(e){this.particleSystem&&this.particleSystem.update(e)}triggerPulse(e,t,i,a,r,s){!this.particleSystem||!this.enabled||this.particleSystem.spawnParticle(t.x,t.y,i.x,i.y)}dispose(){this.particleSystem&&this.particleSystem.dispose()}getConfigOptions(){return[{type:"range",name:"particleSize",label:"Particle Size",value:this.config.particleSize||p.CONFIG["Particle Size"].value,min:.5,max:5,step:.1,section:"Particle Animation"},{type:"range",name:"particleGlow",label:"Particle Glow",value:this.config.particleGlow||p.CONFIG["Particle Glow"].value,min:0,max:2,step:.1,section:"Particle Animation"},{type:"range",name:"particleTravelTime",label:"Travel Time (s)",value:this.config.particleTravelTime||p.CONFIG["Travel Time"].value,min:.1,max:2,step:.1,section:"Particle Animation"},{type:"color",name:"particleColor",label:"Particle Color",value:this.config.particleColor||p.CONFIG["Particle Color"].value,section:"Particle Animation"}]}updateConfig(e){super.updateConfig(e),this.particleSystem&&(this.particleSystem.config=this.config),e.particleSize!==void 0&&(p.CONFIG["Particle Size"].value=e.particleSize),e.particleGlow!==void 0&&(p.CONFIG["Particle Glow"].value=e.particleGlow),e.particleTravelTime!==void 0&&(p.CONFIG["Travel Time"].value=e.particleTravelTime),e.particleColor!==void 0&&(p.CONFIG["Particle Color"].value=e.particleColor)}}const m={a1:100,a:80,b:65,c:40,d:30,e:20,f:5};function k(h){return h.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}const o={"Bundle Spacing":{value:.65,type:"range",min:.1,max:2,step:.05,label:"Bundle Spacing (squares)",section:"Bundle Layout"},"Page Perimeter":{value:2.5,type:"range",min:0,max:10,step:.5,label:"Page Perimeter (squares)",section:"Bundle Layout"},"Counter Height":{value:2,type:"range",min:1,max:5,step:.1,label:"Counter Height (squares)",section:"Bundle Layout"},"Primary Rate":{value:85,type:"range",min:30,max:180,step:1,label:"Primary Rate (BPM)",section:"Pulse Rates"},"Secondary Rate":{value:26,type:"range",min:10,max:100,step:1,label:"Secondary Rate (BPM)",section:"Pulse Rates"},"Rate Variation":{value:35,type:"range",min:0,max:100,step:1,label:"Rate Variation (%)",section:"Pulse Rates"},"Active Bundle Percentage":{value:85,type:"range",min:0,max:100,step:5,label:"Active Bundle %",section:"Pulse Rates"},"Fade Rate":{value:1.4,type:"range",min:.1,max:3,step:.1,label:"Fade Rate",section:"Pulse Rates"},"Text Scale":{value:1.2,type:"range",min:.5,max:2,step:.1,label:"Text Scale Factor",section:"Visual Effects"},"Text Glow":{value:.6,type:"range",min:0,max:1,step:.05,label:"Text Glow",section:"Visual Effects"},"Text Color":{value:"#23CD3C",type:"color",label:"Text Color",section:"Visual Effects"},"Show Counters":{value:!1,type:"checkbox",label:"Show Counters",section:"Animation Settings"},"Animation Type":{value:"wire",type:"select",label:"Animation Type",section:"Animation Settings",options:[{value:"wire",label:"Wire (Curved Lines)"},{value:"particle",label:"Particle (Straight)"}]},"Enable Animation":{value:!1,type:"checkbox",label:"Enable Animation",section:"Animation Settings"},"Internal: Bundle Count":77,"Internal: Square Size":58,"Internal: Spacing":1,"Internal: Counter Delay":.5};z("config",o,{onChange:(h,e,t)=>{if(h==="Bundle Spacing"){t&&t.renderer&&t.renderer.setBundleSpacing(e);return}if(h==="Page Perimeter"){t&&t.renderer&&t.renderer.setPagePerimeter(e);return}if(h==="Counter Height"){t&&t.renderer&&t.renderer.setCounterHeight(e);return}if(h==="Primary Rate"){t&&t.renderer&&t.renderer.setHeartRate1(e);return}if(h==="Secondary Rate"){t&&t.renderer&&t.renderer.setHeartRate2(e);return}if(h==="Rate Variation"){t&&t.renderer&&t.renderer.updateConfig({rateVariation:e/100});return}if(h==="Active Bundle Percentage"){t&&t.renderer&&t.renderer.updateConfig({activeBundlePercentage:e/100});return}if(h==="Fade Rate"){t&&t.renderer&&t.renderer.setFadeRate(e);return}if(h==="Text Scale"){const i=parseFloat(e);t&&t.updateText({scale:i});const a=document.getElementById("data-counter");if(a){const s=20*i;a.style.fontSize=s+"px"}return}if(h==="Text Glow"){const i=parseFloat(e);t&&t.updateText({glow:i});return}if(h==="Text Color"){t&&t.updateText({color:e});return}if(h==="Show Counters"){t&&t.renderer&&t.renderer.setShowCounters(e),t&&e&&t.updateText({scale:o["Text Scale"].value}),S();return}if(h==="Animation Type"){if(t){const i=t.activeAnimator?t.activeAnimator.enabled:!1;t.setAnimationType(e,i)}S();return}if(h==="Enable Animation"){if(t&&t.activeAnimator){t.activeAnimator.setEnabled(e);const i=e?o["Internal: Counter Delay"]:0;t.renderer&&t.renderer.setCounterDelay(i),e&&o["Animation Type"].value==="wire"&&t.activeAnimator.initializeAllLines&&t.activeAnimator.initializeAllLines(t.renderer)}S();return}}});F({title:"Signal Multi Configuration"});class q{constructor(){this.renderer=null,this.time=0,this.fpsCounter=0,this.fpsLastTime=performance.now(),this.fpsFrames=0,this.updateTimeout=null,this.activeAnimator=null,this.lastPulseCounts=new Map,this.init()}init(){const e=document.getElementById("container");if(!e)throw new Error("Container element not found");this.container=e,this.renderer=new G(e,{mode:"multi",bundleCount:o["Internal: Bundle Count"],bundleSpacing:o["Bundle Spacing"].value,pagePerimeter:o["Page Perimeter"].value,counterHeight:o["Counter Height"].value,heartRate1:o["Primary Rate"].value,heartRate2:o["Secondary Rate"].value,squareSize:o["Internal: Square Size"],spacing:o["Internal: Spacing"],activityLevels:{a1:m.a1/100,a:m.a/100,b:m.b/100,c:m.c/100,d:m.d/100,e:m.e/100,f:m.f/100},rateVariation:o["Rate Variation"].value/100,activeBundlePercentage:o["Active Bundle Percentage"].value/100,fadeRate:o["Fade Rate"].value,counterDelay:0,showCounters:o["Show Counters"].value,renderWidth:window.innerWidth,renderHeight:window.innerHeight}),this.setupEventListeners(),this.setupLegendUpdates(),this.setupFPSCounter(),this.setAnimationType(o["Animation Type"].value,o["Enable Animation"].value),this.renderer.animate(),this.updateText({scale:o["Text Scale"].value,glow:o["Text Glow"].value,color:o["Text Color"].value});const t=document.getElementById("data-counter");if(t){const a=20*o["Text Scale"].value;t.style.fontSize=a+"px"}}setAnimationType(e,t=!1){if(this.activeAnimator&&(this.activeAnimator.dispose(),this.activeAnimator=null),o["Animation Type"].value=e,e==="wire"?this.activeAnimator=new v(this.container,{wireLineThickness:v.CONFIG["Line Thickness"].value,wireCurveStrength:v.CONFIG["Curve Strength"].value,wirePulseSpeed:v.CONFIG["Pulse Speed"].value}):e==="particle"&&(this.activeAnimator=new p(this.container,{particleSize:p.CONFIG["Particle Size"].value,particleGlow:p.CONFIG["Particle Glow"].value,particleTravelTime:p.CONFIG["Travel Time"].value,particleColor:p.CONFIG["Particle Color"].value})),this.activeAnimator){this.activeAnimator.init(),this.activeAnimator.setEnabled(t);const i=t?o["Internal: Counter Delay"]:0;this.renderer.setCounterDelay(i),t&&e==="wire"&&this.activeAnimator.initializeAllLines&&this.activeAnimator.initializeAllLines(this.renderer);const a=this.activeAnimator.getConfigOptions(),r={};a.forEach(s=>{r[s.name]={value:s.value,type:s.type,label:s.label,min:s.min,max:s.max,step:s.step,section:s.section}}),z("animator",r,{onChange:(s,n)=>{if(this.activeAnimator&&this.activeAnimator.updateConfig){const l={};l[s]=n,this.activeAnimator.updateConfig(l)}}}),S()}}setupEventListeners(){window.addEventListener("resize",()=>this.handleResize())}handleResize(){this.renderer&&this.renderer.updateDimensions(window.innerWidth,window.innerHeight),this.activeAnimator&&(this.activeAnimator.setEnabled(!1),this.renderer.setCounterDelay(0))}setupLegendUpdates(){let e=0,t=0,i=0;const r=1e3/30,s=n=>{if(n-t>=50){let l=0;if(this.renderer)try{l=this.renderer.getTotalPulseCount()}catch{}e+=(l-e)*.1;const c=document.getElementById("data-counter");c&&(c.textContent="Total Pulses: "+k(Math.round(e))),t=n}n-i>=r?(this.activeAnimator&&(this.activeAnimator.update(n),this.checkForNewPulses()),i=n):this.activeAnimator&&this.activeAnimator.update(n),requestAnimationFrame(s)};requestAnimationFrame(s)}checkForNewPulses(){if(!this.renderer||!this.activeAnimator||!this.activeAnimator.enabled)return;this.renderer.getBundles().forEach((t,i)=>{const a=t.getPulseCount(),r=this.lastPulseCounts.get(i)||0;a>r&&t.getAllSquares().forEach(n=>{const l=n.getPulseCount(),c=this.lastPulseCounts.get(`square_${i}_${n.column}_${n.row}`)||0;if(l>c){const d=this.renderer.config.squareSize,u=this.renderer.config.spacing,g=5*d+4*u,w=t.position.x-g/2+d/2,T=2*d+u,b=t.position.y+T/2-d/2,x=w+n.column*(d+u),C=b-n.row*(d+u),y={x,y:C},A=this.renderer.worldToScreen(y),P=this.getBundleCounterPosition(t,i);if(P){const E=`bundle_${i}_square_${n.column}_${n.row}`;this.activeAnimator.triggerPulse(E,A,P,n.column,n.row,i)}}this.lastPulseCounts.set(`square_${i}_${n.column}_${n.row}`,l)}),this.lastPulseCounts.set(i,a)})}getBundleCounterPosition(e,t){const i=this.renderer.config.spacing,a=this.renderer.config.counterHeight,r=this.renderer.config.squareSize,s=2*r+i,n=a*r+(a-1)*i,l=e.position.y-s/2-i-n/2,c={x:e.position.x,y:l};return this.renderer.worldToScreen(c)}setupFPSCounter(){const e=t=>{(t.key==="t"||t.key==="T")&&(t.preventDefault(),t.stopPropagation(),this.toggleCounters()),(t.key==="r"||t.key==="R")&&(t.preventDefault(),t.stopPropagation(),this.resetAllPulses()),(t.key==="p"||t.key==="P")&&(t.altKey||(t.preventDefault(),t.stopPropagation(),this.toggleAnimation()))};window.addEventListener("keydown",e,!0)}toggleCounters(){const e=!o["Show Counters"].value;o["Show Counters"].value=e,this.renderer&&this.renderer.setShowCounters(e);const t=L.getOnChangeHandler();t&&t("config.Show Counters",e)}resetAllPulses(){this.renderer&&this.renderer.getBundles().forEach(e=>e.resetPulseCount())}toggleAnimation(){if(!this.activeAnimator&&o["Animation Type"].value!=="none"){this.setAnimationType(o["Animation Type"].value,!0);return}const e=!this.activeAnimator.enabled;if(o["Enable Animation"].value=e,this.activeAnimator){this.activeAnimator.setEnabled(e);const i=e?o["Internal: Counter Delay"]:0;this.renderer&&this.renderer.setCounterDelay(i),e&&o["Animation Type"].value==="wire"&&this.activeAnimator.initializeAllLines&&this.activeAnimator.initializeAllLines(this.renderer)}const t=L.getOnChangeHandler();t&&t("config.Enable Animation",e)}updateText({glow:e,scale:t,color:i}){if(!this.renderer)return;const a={};if(typeof e=="number"&&(o["Text Glow"].value=e,a.glow=e*24),t!==void 0){o["Text Scale"].value=parseFloat(t);const s=20*parseFloat(t);a.size=s}i&&(o["Text Color"].value=i,a.color=i),Object.keys(a).length>0&&this.renderer.updateText(a)}}document.addEventListener("DOMContentLoaded",()=>{try{const h=new q;window.signalMultiInstance=h,Y("config",h),window.addEventListener("message",e=>{e.data==="reset"&&h.resetAllPulses()}),document.addEventListener("keydown",e=>{e.ctrlKey&&(e.key==="ArrowLeft"||e.key==="ArrowRight")&&window.parent.postMessage({type:"keydown",key:e.key,ctrlKey:e.ctrlKey},"*")})}catch(h){const e=document.createElement("div");Object.assign(e.style,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",background:"rgba(255, 0, 0, 0.9)",color:"white",padding:"20px",borderRadius:"10px",fontFamily:"monospace",maxWidth:"80vw",maxHeight:"80vh",overflow:"auto"}),e.innerHTML="<h2>Initialization Error</h2><pre>"+h.message+"</pre><pre>"+h.stack+"</pre>",document.body.appendChild(e)}});
