import{b as H,c as B,S as T,C as P,O as W,W as z,V as q}from"./signalSquare-CnPgryvO.js";class A{constructor(t,e={}){this.container=t,this.config={mode:"single",bundleCount:1,bundleSpacing:.65,pagePerimeter:2.5,counterHeight:2,heartRate1:85,heartRate2:26,squareSize:58,spacing:1,activityLevels:{a1:1,a:.8,b:.65,c:.4,d:.3,e:.2,f:.05},rateVariation:.35,showCounters:!1,renderWidth:null,renderHeight:null,fadeRate:1,counterDelay:.5,...e},this.scene=null,this.camera=null,this.renderer=null,this.bundleManager=null,this.bundles=[],this.time=0,this.fpsCounter=0,this.fpsLastTime=performance.now(),this.fpsFrames=0,this.fpsDisplay=null,this.lastFrameTime=performance.now()/1e3,this.pulseCountStore=new Map,this.clusterStatsElements=[],this.textGlow=.6,this.currentTextSize=null,this.currentTextColor="#23CD3C",this.clock=new H,this.isRecreatingBundles=!1,this.pendingConfigUpdate=null,this.init(),this.createBundles(),this.config.showCounters&&this.setShowCounters(!0)}init(){this.setupScene(),this.setupCamera(),this.setupRenderer(),this.setupEventListeners(),this.bundleManager=new B(this.scene,1e3)}setupScene(){this.scene=new T,this.scene.background=new P(855309)}setupCamera(){const t=this.config.renderWidth||this.container.clientWidth||window.innerWidth,e=this.config.renderHeight||this.container.clientHeight||window.innerHeight;this.camera=new W(-t/2,t/2,e/2,-e/2,.1,1e3),this.camera.position.z=10}setupRenderer(){this.renderer=new z({antialias:!0,powerPreference:"high-performance"});const t=this.config.renderWidth||this.container.clientWidth||window.innerWidth,e=this.config.renderHeight||this.container.clientHeight||window.innerHeight;this.renderer.setSize(t,e),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,3)),this.renderer.setClearColor(855309),this.renderer.shadowMap.enabled=!1,this.renderer.domElement.style.position="absolute",this.renderer.domElement.style.top="0",this.renderer.domElement.style.left="0",this.renderer.domElement.style.zIndex="5",this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%",this.container.appendChild(this.renderer.domElement)}setupEventListeners(){}handleResize(){}updateCameraBounds(){const t=this.config.renderWidth||this.container.clientWidth||window.innerWidth,e=this.config.renderHeight||this.container.clientHeight||window.innerHeight;this.camera.left=-t/2,this.camera.right=t/2,this.camera.top=e/2,this.camera.bottom=-e/2,this.camera.updateProjectionMatrix()}createBundles(){if(!this.isRecreatingBundles){this.isRecreatingBundles=!0;try{this.clearExistingBundles(),this.config.mode==="single"?this.createSingleBundle():this.createMultiBundles()}finally{if(this.isRecreatingBundles=!1,this.pendingConfigUpdate){const t=this.pendingConfigUpdate;this.pendingConfigUpdate=null,setTimeout(()=>this.updateConfig(t),0)}}}}createSingleBundle(){const t=Math.abs(this.camera.right-this.camera.left),e=Math.abs(this.camera.top-this.camera.bottom),i=5,s=2,n=.9,r=t*n/i,c=e*n/s,o=Math.min(r,c),u=Math.max(20,Math.min(o,120));this.config.squareSize=u;const a=this.bundleManager.createBundle({x:0,y:0},{squareSize:this.config.squareSize,spacing:this.config.spacing,counterWidth:0,rate1:this.config.heartRate1/60,rate2:this.config.heartRate2/60,timeOffset:0,activityPercentages:this.config.activityLevels,rateVariation:this.config.rateVariation,fadeRate:this.config.fadeRate});a&&(this.bundles.push(a),a.setCounterVisible(!1))}createMultiBundles(){const t=this.calculateOptimalSquareSize(),e=this.config.spacing,i=this.config.bundleSpacing*t,s=this.config.pagePerimeter+55+10*this.config.bundleSpacing+this.config.pagePerimeter,n=this.config.pagePerimeter+14+6*this.config.bundleSpacing+this.config.pagePerimeter,r=this.config.pagePerimeter/s*Math.abs(this.camera.right-this.camera.left),c=this.config.pagePerimeter/n*Math.abs(this.camera.top-this.camera.bottom),o=Math.min(r,c),u=5*t+4*e,l=this.config.counterHeight*t+(this.config.counterHeight-1)*e,h=u,a=2*t+e,d=e+l,p=a+d+i,S=11*h+10*i,C=7*(a+d)+6*i,b=-(S+2*o)/2+h/2+o,x=1*t,y=C/2-a/2-x;let E=0;for(let g=0;g<7;g++)for(let f=0;f<11&&!(g*11+f>=this.config.bundleCount);f++){const w=b+f*(h+i),M=y-g*p;try{const m=this.createSingleBundleAt(w,M,t,e);m&&(this.bundles.push(m),E++)}catch{}}this.config.squareSize=t}createSingleBundleAt(t,e,i,s){try{const n=Math.random()*4;return this.bundleManager.createBundle({x:t,y:e},{squareSize:i,spacing:s,counterWidth:this.config.counterHeight,rate1:this.config.heartRate1/60,rate2:this.config.heartRate2/60,timeOffset:n,activityPercentages:this.config.activityLevels,rateVariation:this.config.rateVariation,fadeRate:this.config.fadeRate})}catch{return null}}calculateOptimalSquareSize(){const{width:t,height:e}=this.getScreenDimensions(),i=11,s=7,n=this.config.bundleSpacing,r=this.config.pagePerimeter,c=this.config.counterHeight;if(t<=0||e<=0||n<0||r<0||c<0)return 20;const o=i*5+(i-1)*n,u=s*(2+c)+(s-1)*n,l=r+o+r,h=r+u+r;if(l<=0||h<=0)return 20;const a=t/l,d=e/h,p=Math.min(a,d);return Math.max(10,Math.min(p,80))}getScreenDimensions(){return this.config.renderWidth&&this.config.renderHeight?{width:Math.max(1,this.config.renderWidth),height:Math.max(1,this.config.renderHeight)}:this.camera?{width:Math.max(1,Math.abs(this.camera.right-this.camera.left)),height:Math.max(1,Math.abs(this.camera.top-this.camera.bottom))}:{width:Math.max(1,window.innerWidth||800),height:Math.max(1,window.innerHeight||600)}}clearExistingBundles(){try{this.bundles&&Array.isArray(this.bundles)&&this.bundles.forEach(t=>{if(t&&typeof t.dispose=="function")try{t.dispose()}catch{}}),this.bundles=[],this.clearExistingStatsElements()}catch{this.bundles=[],this.clearExistingStatsElements()}}storePulseCounts(){this.pulseCountStore.clear(),this.bundles.forEach((t,e)=>{const i=t.getAllSquares().map(s=>s.getPulseCount());this.pulseCountStore.set(e,i)})}restorePulseCounts(){this.bundles.forEach((t,e)=>{const i=this.pulseCountStore.get(e);i&&t.getAllSquares().forEach((n,r)=>{i[r]!==void 0&&n.setPulseCount(i[r])})})}updateDimensions(t,e){if(this.isRecreatingBundles){this.pendingConfigUpdate?(this.pendingConfigUpdate.renderWidth=t,this.pendingConfigUpdate.renderHeight=e):this.pendingConfigUpdate={renderWidth:t,renderHeight:e};return}this.config.renderWidth=t,this.config.renderHeight=e,this.renderer.setSize(t,e),this.updateCameraBounds(),this.storePulseCounts(),this.createBundles(),this.restorePulseCounts(),this.bundles.forEach(i=>i.setCounterVisible(this.config.showCounters)),this.config.showCounters&&this.createClusterStatsDisplays()}updateConfig(t){try{if(this.isRecreatingBundles){this.pendingConfigUpdate={...this.pendingConfigUpdate,...t};return}this.storePulseCounts(),Object.assign(this.config,t),t.bundleCount!==void 0?this.updateBundleCount(t.bundleCount):t.counterDelay!==void 0?this.setCounterDelay(t.counterDelay):(this.createBundles(),this.restorePulseCounts()),this.bundles.forEach(e=>e.setCounterVisible(this.config.showCounters)),this.config.showCounters&&this.createClusterStatsDisplays()}catch{this.pulseCountStore.size>0&&this.restorePulseCounts()}}setBundleSpacing(t){const e=Math.max(.1,Math.min(5,t));this.updateConfig({bundleSpacing:e})}setPagePerimeter(t){const e=Math.max(0,Math.min(20,t));this.updateConfig({pagePerimeter:e})}setCounterHeight(t){const e=Math.max(.5,Math.min(10,t));this.updateConfig({counterHeight:e})}setCounterDelay(t){const e=Math.max(0,Math.min(2,t));this.config.counterDelay=e,this.safeBundleOperation(()=>{this.bundles.forEach(i=>i.setCounterDelay(e))})}setBundleCount(t){this.updateConfig({bundleCount:t})}updateBundleCount(t){if(this.isRecreatingBundles){this.pendingConfigUpdate?this.pendingConfigUpdate.bundleCount=t:this.pendingConfigUpdate={bundleCount:t};return}this.config.bundleCount=t,this.storePulseCounts(),this.createBundles(),this.restorePulseCounts()}setHeartRate1(t){this.config.heartRate1=t;const e=t/60;this.safeBundleOperation(()=>{this.bundles.forEach(i=>i.setRate1(e))})}setHeartRate2(t){this.config.heartRate2=t;const e=t/60;this.safeBundleOperation(()=>{this.bundles.forEach(i=>i.setRate2(e))})}setActivityLevels(t){this.config.activityLevels={...this.config.activityLevels,...t},this.safeBundleOperation(()=>{this.bundles.forEach(e=>e.updateActivityLevels(this.config.activityLevels))})}setFadeRate(t){this.config.fadeRate=t,this.safeBundleOperation(()=>{this.bundleManager.setGlobalFadeRate(t)})}setShowCounters(t){this.config.showCounters=t,this.safeBundleOperation(()=>{this.bundles.forEach(e=>e.setCounterVisible(t))}),t?this.createClusterStatsDisplays():this.clearExistingStatsElements()}createClusterStatsDisplays(){if(this.clearExistingStatsElements(),!this.config.showCounters||this.config.mode==="single")return;(!this.config.squareSize||this.config.squareSize<=0)&&(this.config.squareSize=this.calculateOptimalSquareSize());const t=Math.max(10,Math.min(24,this.config.squareSize*.4));this.cachedBeatElements=[],this.bundles.forEach(()=>{const e=this.createStatsElement(`${t}px`),i=e.querySelector(".beat-count");this.cachedBeatElements.push(i),document.body.appendChild(e),this.clusterStatsElements.push(e)}),this.updateClusterStatsPositions()}clearExistingStatsElements(){try{this.clusterStatsElements&&Array.isArray(this.clusterStatsElements)&&this.clusterStatsElements.forEach(t=>{if(t&&t.parentNode)try{t.parentNode.removeChild(t)}catch{}}),this.clusterStatsElements=[],this.cachedBeatElements=[]}catch{this.clusterStatsElements=[],this.cachedBeatElements=[]}}createStatsElement(t="14px"){const e=document.createElement("div"),i=parseFloat(t);return Object.assign(e.style,{position:"absolute",background:"transparent",color:this.currentTextColor||"#23CD3C",padding:"0",borderRadius:"0",fontSize:this.currentTextSize?this.currentTextSize+"px":t,fontFamily:"monospace",pointerEvents:"none",zIndex:"1000",minWidth:`${(this.currentTextSize?parseFloat(this.currentTextSize):i)*2}px`,width:`${(this.currentTextSize?parseFloat(this.currentTextSize):i)*2.5}px`,height:`${(this.currentTextSize?parseFloat(this.currentTextSize):i)*1.2}px`,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",opacity:this.textGlow.toString(),textShadow:`0 0 8px ${this.currentTextColor||"#23CD3C"}, 0 0 16px ${this.currentTextColor||"#23CD3C"}`,fontWeight:"bold"}),e.innerHTML='<span class="beat-count">0</span>',e}updateClusterStatsPositions(){if(!(!this.config.showCounters||this.clusterStatsElements.length!==this.bundles.length||this.config.mode==="single")&&(this.positionThrottle=(this.positionThrottle||0)+1,this.positionThrottle%10===0))try{const t=this.config.spacing,e=this.config.counterHeight,i=e*this.config.squareSize;this.bundles.forEach((s,n)=>{const r=this.clusterStatsElements[n];if(!r||!s)return;const c=5*this.config.squareSize+4*t,o=2*this.config.squareSize+t,u=i+(e-1)*t,l=s.position.y-o/2-t-u/2,h=this.worldToScreen({x:s.position.x,y:l}),a=`translate(${h.x}px, ${h.y}px) translate(-50%, -50%)`;r.style.transform!==a&&(r.style.transform=a,r.style.left="0",r.style.top="0")})}catch{}}worldToScreen(t){try{if(!this.camera)return{x:0,y:0};const e=new q(t.x,t.y,0);e.project(this.camera);const i=this.config.renderWidth||window.innerWidth||800,s=this.config.renderHeight||window.innerHeight||600,n=(e.x*.5+.5)*i,r=(-e.y*.5+.5)*s;return{x:n,y:r}}catch{return{x:0,y:0}}}updateClusterStatsDisplays(){if(!(!this.config.showCounters||this.clusterStatsElements.length!==this.bundles.length||!this.cachedBeatElements||this.config.mode==="single")&&(this.updateThrottle=(this.updateThrottle||0)+1,this.updateThrottle%3===0))try{this.bundles.forEach((t,e)=>{const i=this.cachedBeatElements[e];if(!i||!t)return;const s=t.getPulseCount();i.textContent!==s.toString()&&(i.textContent=s)})}catch{}}animate(){requestAnimationFrame(()=>this.animate());const t=performance.now(),e=this.lastFrameTime?t-this.lastFrameTime:0;this.lastFrameTime=t;const i=Math.min(e,33);this.bundleManager.update(i),this.updateClusterStatsDisplays(),this.updateClusterStatsPositions(),this.updateFPS(),this.camera.lookAt(0,0,0),this.renderer.render(this.scene,this.camera)}updateFPS(){this.fpsFrames++;const t=performance.now();t>=this.fpsLastTime+1e3&&(this.fpsCounter=Math.round(this.fpsFrames*1e3/(t-this.fpsLastTime)),this.fpsFrames=0,this.fpsLastTime=t,this.fpsDisplay&&(this.fpsDisplay.textContent=this.fpsCounter))}updateText({glow:t,size:e,color:i}){if(typeof t=="number"){const s=Math.max(0,Math.min(1,t/24));this.textGlow=s,this.clusterStatsElements.forEach(n=>{n&&(n.style.opacity=s.toString())})}e&&(this.currentTextSize=e,this.clusterStatsElements.forEach(s=>{if(s){s.style.fontSize=e+"px";const n=parseFloat(e);s.style.minWidth=`${n*2}px`,s.style.width=`${n*2.5}px`,s.style.height=`${n*1.2}px`}})),i&&(this.currentTextColor=i,this.clusterStatsElements.forEach(s=>{s&&(s.style.color=i,s.style.textShadow=`0 0 8px ${i}, 0 0 16px ${i}`)}))}isValidState(){return this.scene&&this.camera&&this.renderer&&this.bundleManager&&!this.isRecreatingBundles}safeBundleOperation(t){if(this.isValidState()&&this.bundles&&this.bundles.length>0)try{t()}catch{}}getTotalPulseCount(){try{return this.bundleManager&&typeof this.bundleManager.getTotalPulseCount=="function"?this.bundleManager.getTotalPulseCount():0}catch{return 0}}getBundles(){return this.bundles||[]}getConfig(){return{...this.config}}dispose(){this.clearExistingBundles(),this.renderer&&(this.container.removeChild(this.renderer.domElement),this.renderer.dispose()),this.bundleManager&&this.bundleManager.dispose()}}export{A as S};
