import{b as H,c as B,S as P,C as W,O as q,W as R,V as v}from"./signalSquare-CzoGnx3u.js";class O{constructor(t,e={}){this.container=t,this.config={mode:"single",bundleCount:1,bundleSpacing:.65,pagePerimeter:2.5,counterHeight:2,heartRate1:85,heartRate2:26,squareSize:58,spacing:1,activityLevels:{a1:1,a:.8,b:.65,c:.4,d:.3,e:.2,f:.05},rateVariation:.35,showCounters:!1,renderWidth:null,renderHeight:null,fadeRate:1,counterDelay:.5,...e},this.scene=null,this.camera=null,this.renderer=null,this.bundleManager=null,this.bundles=[],this.time=0,this.fpsCounter=0,this.fpsLastTime=performance.now(),this.fpsFrames=0,this.fpsDisplay=null,this.lastFrameTime=performance.now()/1e3,this.pulseCountStore=new Map,this.clusterStatsElements=[],this.textGlow=.6,this.clock=new H,this.isRecreatingBundles=!1,this.pendingConfigUpdate=null,this.init(),this.createBundles()}init(){this.setupScene(),this.setupCamera(),this.setupRenderer(),this.setupEventListeners(),this.bundleManager=new B(this.scene,1e3)}setupScene(){this.scene=new P,this.scene.background=new W(855309)}setupCamera(){const t=this.config.renderWidth||this.container.clientWidth||window.innerWidth,e=this.config.renderHeight||this.container.clientHeight||window.innerHeight;this.camera=new q(-t/2,t/2,e/2,-e/2,.1,1e3),this.camera.position.z=10}setupRenderer(){this.renderer=new R({antialias:!0,powerPreference:"high-performance"});const t=this.config.renderWidth||this.container.clientWidth||window.innerWidth,e=this.config.renderHeight||this.container.clientHeight||window.innerHeight;this.renderer.setSize(t,e),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,3)),this.renderer.setClearColor(855309),this.renderer.shadowMap.enabled=!1,this.renderer.domElement.style.position="absolute",this.renderer.domElement.style.top="0",this.renderer.domElement.style.left="0",this.renderer.domElement.style.zIndex="5",this.renderer.domElement.style.width="100%",this.renderer.domElement.style.height="100%",this.container.appendChild(this.renderer.domElement),setTimeout(()=>{this.container.querySelectorAll("canvas").forEach((i,n)=>{})},100)}setupEventListeners(){}handleResize(){}updateCameraBounds(){const t=this.config.renderWidth||this.container.clientWidth||window.innerWidth,e=this.config.renderHeight||this.container.clientHeight||window.innerHeight;this.camera.left=-t/2,this.camera.right=t/2,this.camera.top=e/2,this.camera.bottom=-e/2,this.camera.updateProjectionMatrix()}createBundles(){if(!this.isRecreatingBundles){this.isRecreatingBundles=!0;try{this.clearExistingBundles(),this.config.mode==="single"?this.createSingleBundle():this.createMultiBundles()}finally{if(this.isRecreatingBundles=!1,this.pendingConfigUpdate){const t=this.pendingConfigUpdate;this.pendingConfigUpdate=null,setTimeout(()=>this.updateConfig(t),0)}}}}createSingleBundle(){const t=Math.abs(this.camera.right-this.camera.left),e=Math.abs(this.camera.top-this.camera.bottom),s=5,i=2,n=.9,r=t*n/s,c=e*n/i,h=Math.min(r,c),l=Math.max(20,Math.min(h,120));this.config.squareSize=l;const a=this.bundleManager.createBundle({x:0,y:0},{squareSize:this.config.squareSize,spacing:this.config.spacing,counterWidth:0,rate1:this.config.heartRate1/60,rate2:this.config.heartRate2/60,timeOffset:0,activityPercentages:this.config.activityLevels,rateVariation:this.config.rateVariation,fadeRate:this.config.fadeRate});a&&(this.bundles.push(a),a.setCounterVisible(!1))}createMultiBundles(){const t=this.calculateOptimalSquareSize(),e=this.config.spacing,s=this.config.bundleSpacing*t,i=this.config.pagePerimeter+55+10*this.config.bundleSpacing+this.config.pagePerimeter,n=this.config.pagePerimeter+14+6*this.config.bundleSpacing+this.config.pagePerimeter,r=this.config.pagePerimeter/i*Math.abs(this.camera.right-this.camera.left),c=this.config.pagePerimeter/n*Math.abs(this.camera.top-this.camera.bottom),h=Math.min(r,c),l=5*t+4*e,u=this.config.counterHeight*t+(this.config.counterHeight-1)*e,o=l,a=2*t+e,d=e+u,g=a+d+s,f=11*o+10*s,C=7*(a+d)+6*s,b=-(f+2*h)/2+o/2+h,y=1*t,E=C/2-a/2-y;let x=0;for(let p=0;p<7;p++)for(let m=0;m<11&&!(p*11+m>=this.config.bundleCount);m++){const M=b+m*(o+s),w=E-p*g;try{const S=this.createSingleBundleAt(M,w,t,e);S&&(this.bundles.push(S),x++)}catch{}}this.config.squareSize=t}createSingleBundleAt(t,e,s,i){try{const n=Math.random()*4;return this.bundleManager.createBundle({x:t,y:e},{squareSize:s,spacing:i,counterWidth:this.config.counterHeight,rate1:this.config.heartRate1/60,rate2:this.config.heartRate2/60,timeOffset:n,activityPercentages:this.config.activityLevels,rateVariation:this.config.rateVariation,fadeRate:this.config.fadeRate})}catch{return null}}calculateOptimalSquareSize(){const{width:t,height:e}=this.getScreenDimensions(),s=11,i=7,n=this.config.bundleSpacing,r=this.config.pagePerimeter,c=this.config.counterHeight;if(t<=0||e<=0||n<0||r<0||c<0)return 20;const h=s*5+(s-1)*n,l=i*(2+c)+(i-1)*n,u=r+h+r,o=r+l+r;if(u<=0||o<=0)return 20;const a=t/u,d=e/o,g=Math.min(a,d);return Math.max(10,Math.min(g,80))}getScreenDimensions(){return this.config.renderWidth&&this.config.renderHeight?{width:Math.max(1,this.config.renderWidth),height:Math.max(1,this.config.renderHeight)}:this.camera?{width:Math.max(1,Math.abs(this.camera.right-this.camera.left)),height:Math.max(1,Math.abs(this.camera.top-this.camera.bottom))}:{width:Math.max(1,window.innerWidth||800),height:Math.max(1,window.innerHeight||600)}}clearExistingBundles(){try{this.bundles&&Array.isArray(this.bundles)&&this.bundles.forEach(t=>{if(t&&typeof t.dispose=="function")try{t.dispose()}catch{}}),this.bundles=[],this.clearExistingStatsElements()}catch{this.bundles=[],this.clearExistingStatsElements()}}storePulseCounts(){this.pulseCountStore.clear(),this.bundles.forEach((t,e)=>{const s=t.getAllSquares().map(i=>i.getPulseCount());this.pulseCountStore.set(e,s)})}restorePulseCounts(){this.bundles.forEach((t,e)=>{const s=this.pulseCountStore.get(e);s&&t.getAllSquares().forEach((n,r)=>{s[r]!==void 0&&n.setPulseCount(s[r])})})}updateDimensions(t,e){if(this.isRecreatingBundles){this.pendingConfigUpdate?(this.pendingConfigUpdate.renderWidth=t,this.pendingConfigUpdate.renderHeight=e):this.pendingConfigUpdate={renderWidth:t,renderHeight:e};return}this.config.renderWidth=t,this.config.renderHeight=e,this.renderer.setSize(t,e),this.updateCameraBounds(),this.storePulseCounts(),this.createBundles(),this.restorePulseCounts(),this.bundles.forEach(s=>s.setCounterVisible(this.config.showCounters)),this.config.showCounters&&this.createClusterStatsDisplays()}updateConfig(t){try{if(this.isRecreatingBundles){this.pendingConfigUpdate={...this.pendingConfigUpdate,...t};return}this.storePulseCounts(),Object.assign(this.config,t),t.bundleCount!==void 0?this.updateBundleCount(t.bundleCount):t.counterDelay!==void 0?this.setCounterDelay(t.counterDelay):(this.createBundles(),this.restorePulseCounts()),this.bundles.forEach(e=>e.setCounterVisible(this.config.showCounters)),this.config.showCounters&&this.createClusterStatsDisplays()}catch{this.pulseCountStore.size>0&&this.restorePulseCounts()}}setBundleSpacing(t){const e=Math.max(.1,Math.min(5,t));this.updateConfig({bundleSpacing:e})}setPagePerimeter(t){const e=Math.max(0,Math.min(20,t));this.updateConfig({pagePerimeter:e})}setCounterHeight(t){const e=Math.max(.5,Math.min(10,t));this.updateConfig({counterHeight:e})}setCounterDelay(t){const e=Math.max(0,Math.min(2,t));this.config.counterDelay=e,this.safeBundleOperation(()=>{this.bundles.forEach(s=>s.setCounterDelay(e))})}setBundleCount(t){this.updateConfig({bundleCount:t})}updateBundleCount(t){if(this.isRecreatingBundles){this.pendingConfigUpdate?this.pendingConfigUpdate.bundleCount=t:this.pendingConfigUpdate={bundleCount:t};return}this.config.bundleCount=t,this.storePulseCounts(),this.createBundles(),this.restorePulseCounts()}setHeartRate1(t){this.config.heartRate1=t;const e=t/60;this.safeBundleOperation(()=>{this.bundles.forEach(s=>s.setRate1(e))})}setHeartRate2(t){this.config.heartRate2=t;const e=t/60;this.safeBundleOperation(()=>{this.bundles.forEach(s=>s.setRate2(e))})}setActivityLevels(t){this.config.activityLevels={...this.config.activityLevels,...t},this.safeBundleOperation(()=>{this.bundles.forEach(e=>e.updateActivityLevels(this.config.activityLevels))})}setFadeRate(t){this.config.fadeRate=t,this.safeBundleOperation(()=>{this.bundleManager.setGlobalFadeRate(t)})}setShowCounters(t){this.config.showCounters=t,this.safeBundleOperation(()=>{this.bundles.forEach(e=>e.setCounterVisible(t))}),t?this.createClusterStatsDisplays():this.clearExistingStatsElements()}createClusterStatsDisplays(){if(this.clearExistingStatsElements(),!this.config.showCounters||this.config.mode==="single")return;(!this.config.squareSize||this.config.squareSize<=0)&&(this.config.squareSize=this.calculateOptimalSquareSize());const t=Math.max(10,Math.min(24,this.config.squareSize*.4));this.cachedBeatElements=[],this.bundles.forEach(()=>{const e=this.createStatsElement(`${t}px`),s=e.querySelector(".beat-count");this.cachedBeatElements.push(s),document.body.appendChild(e),this.clusterStatsElements.push(e)}),this.updateClusterStatsPositions()}clearExistingStatsElements(){try{this.clusterStatsElements&&Array.isArray(this.clusterStatsElements)&&this.clusterStatsElements.forEach(t=>{if(t&&t.parentNode)try{t.parentNode.removeChild(t)}catch{}}),this.clusterStatsElements=[],this.cachedBeatElements=[]}catch{this.clusterStatsElements=[],this.cachedBeatElements=[]}}createStatsElement(t="14px"){const e=document.createElement("div"),s=parseFloat(t);return Object.assign(e.style,{position:"absolute",background:"transparent",color:"#23CD3C",padding:"0",borderRadius:"0",fontSize:t,fontFamily:"monospace",pointerEvents:"none",zIndex:"1000",minWidth:`${s*2}px`,textAlign:"center",opacity:this.textGlow.toString(),textShadow:"0 0 8px #23CD3C, 0 0 16px #23CD3C",fontWeight:"bold"}),e.innerHTML='<span class="beat-count">0</span>',e}updateClusterStatsPositions(){if(!(!this.config.showCounters||this.clusterStatsElements.length!==this.bundles.length||this.config.mode==="single")&&(this.positionThrottle=(this.positionThrottle||0)+1,this.positionThrottle%10===0))try{const t=this.config.spacing,e=this.config.counterHeight,s=e*this.config.squareSize;this.bundles.forEach((i,n)=>{const r=this.clusterStatsElements[n];if(!r||!i)return;const c=5*this.config.squareSize+4*t,h=2*this.config.squareSize+t,l=s+(e-1)*t,u=i.position.y-h/2-t-l/2,o=this.worldToScreen({x:i.position.x,y:u}),a=parseFloat(r.style.fontSize),d=a*1.07,g=a*.57,f=`translate(${o.x-d}px, ${o.y-g}px)`;r.style.transform!==f&&(r.style.transform=f,r.style.left="0",r.style.top="0")})}catch{}}worldToScreen(t){try{if(!this.camera)return{x:0,y:0};const e=new v(t.x,t.y,0);e.project(this.camera);const s=this.config.renderWidth||window.innerWidth||800,i=this.config.renderHeight||window.innerHeight||600,n=(e.x*.5+.5)*s,r=(-e.y*.5+.5)*i;return{x:n,y:r}}catch{return{x:0,y:0}}}updateClusterStatsDisplays(){if(!(!this.config.showCounters||this.clusterStatsElements.length!==this.bundles.length||!this.cachedBeatElements||this.config.mode==="single")&&(this.updateThrottle=(this.updateThrottle||0)+1,this.updateThrottle%3===0))try{this.bundles.forEach((t,e)=>{const s=this.cachedBeatElements[e];if(!s||!t)return;const i=t.getPulseCount();s.textContent!==i.toString()&&(s.textContent=i)})}catch{}}animate(){requestAnimationFrame(()=>this.animate());const t=performance.now()/1e3,e=this.lastFrameTime?t-this.lastFrameTime:0;this.lastFrameTime=t;const s=Math.min(e,.033);this.bundleManager.update(s),this.updateClusterStatsDisplays(),this.updateClusterStatsPositions(),this.updateFPS(),this.camera.lookAt(0,0,0),this.renderer.render(this.scene,this.camera)}updateFPS(){this.fpsFrames++;const t=performance.now();t>=this.fpsLastTime+1e3&&(this.fpsCounter=Math.round(this.fpsFrames*1e3/(t-this.fpsLastTime)),this.fpsFrames=0,this.fpsLastTime=t,this.fpsDisplay&&(this.fpsDisplay.textContent=this.fpsCounter))}updateText({glow:t,size:e,color:s}){if(typeof t=="number"){const i=Math.max(0,Math.min(1,t/24));this.textGlow=i,this.clusterStatsElements.forEach(n=>{n&&(n.style.opacity=i.toString())})}e&&(this.clusterStatsElements.forEach(i=>{if(i){i.style.fontSize=e+"px";const n=parseFloat(e);i.style.minWidth=`${n*2}px`}}),this.config.showCounters&&this.updateClusterStatsPositions()),s&&this.clusterStatsElements.forEach(i=>{i&&(i.style.color=s,i.style.textShadow=`0 0 8px ${s}, 0 0 16px ${s}`)})}isValidState(){return this.scene&&this.camera&&this.renderer&&this.bundleManager&&!this.isRecreatingBundles}safeBundleOperation(t){if(this.isValidState()&&this.bundles&&this.bundles.length>0)try{t()}catch{}}getTotalPulseCount(){try{return this.bundleManager&&typeof this.bundleManager.getTotalPulseCount=="function"?this.bundleManager.getTotalPulseCount():0}catch{return 0}}getBundles(){return this.bundles||[]}getConfig(){return{...this.config}}dispose(){this.clearExistingBundles(),this.renderer&&(this.container.removeChild(this.renderer.domElement),this.renderer.dispose()),this.bundleManager&&this.bundleManager.dispose()}}export{O as S};
